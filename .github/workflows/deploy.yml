# ğŸ­ Lady Guardr's Deployment Pipeline
# Auto-deploys to DigitalOcean when you push to main

name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger button

env:
  REGISTRY: registry.digitalocean.com
  IMAGE_NAME: guardr-registry/guardr-api

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD & TEST
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@1.85.0
        with:
          components: clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run clippy
        run: cargo clippy -- -D warnings -A clippy::redundant_pattern_matching -A clippy::needless_borrows_for_generic_args -A dead_code -A unused_variables

      - name: Run tests
        run: cargo test

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD & PUSH DOCKER IMAGE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build
    environment: v66
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login

      - name: Build and push image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest .
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY TO DROPLET
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: Deploy to Droplet
    runs-on: ubuntu-latest
    needs: docker
    environment: v66
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          MONGODB_URL: ${{ secrets.MONGODB_URL }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          GUARDR_SERVER__HOST: ${{ secrets.GUARDR_SERVER__HOST }}
          GUARDR_SERVER__PORT: ${{ secrets.GUARDR_SERVER__PORT }}
          GUARDR_LOGGING__LEVEL: ${{ secrets.GUARDR_LOGGING__LEVEL }}
          HIBP_API_KEY: ${{ secrets.HIBP_API_KEY }}
          INTELX_API_KEY: ${{ secrets.INTELX_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: guardr
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: MONGODB_URL,DATABASE_URL,JWT_SECRET,REDIS_URL,ENCRYPTION_KEY,GUARDR_SERVER__HOST,GUARDR_SERVER__PORT,GUARDR_LOGGING__LEVEL,HIBP_API_KEY,INTELX_API_KEY,GEMINI_API_KEY
          script: |
            # Pull latest image
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            
            # Stop old container
            docker stop guardr-api || true
            docker rm guardr-api || true
            
            # Start new container
            docker run -d \
              --name guardr-api \
              --restart unless-stopped \
              -p 5000:5000 \
              -v /app/data:/app/data \
              -e MONGODB_URL="$MONGODB_URL" \
              -e DATABASE_URL="$DATABASE_URL" \
              -e JWT_SECRET="$JWT_SECRET" \
              -e REDIS_URL="$REDIS_URL" \
              -e ENCRYPTION_KEY="$ENCRYPTION_KEY" \
              -e GUARDR_SERVER__HOST="$GUARDR_SERVER__HOST" \
              -e GUARDR_SERVER__PORT="$GUARDR_SERVER__PORT" \
              -e GUARDR_LOGGING__LEVEL="$GUARDR_LOGGING__LEVEL" \
              -e HIBP_API_KEY="$HIBP_API_KEY" \
              -e INTELX_API_KEY="$INTELX_API_KEY" \
              -e GEMINI_API_KEY="$GEMINI_API_KEY" \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            
            # Cleanup old images
            docker image prune -f

      - name: Notify success
        run: echo "âœ¨ Deployed successfully, darling! âœ¨"
